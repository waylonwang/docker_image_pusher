name: Specify Images  # æŒ‡å®šé•œåƒ

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]  # å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘

env:
  MY_REGISTRY: "${{ secrets.MY_REGISTRY }}"  # é•œåƒä»“åº“åœ°å€
  MY_REGISTRY_USER: "${{ secrets.MY_REGISTRY_USER }}"  # é•œåƒä»“åº“ç”¨æˆ·å
  MY_REGISTRY_PASSWORD: "${{ secrets.MY_REGISTRY_PASSWORD }}"  # é•œåƒä»“åº“å¯†ç 

jobs:
  build:
    name: Pull images and Push Images 
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–°çš„ Ubuntu è¿è¡Œå™¨
    steps:
    - name: Install skopeo, jq, and yq
      run: | 
        sudo apt-get update
        sudo apt-get install -y skopeo jq
        sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
        sudo chmod +x /usr/bin/yq

    - name: Checkout Code
      uses: actions/checkout@v4  # æ£€å‡ºä»£ç ä»“åº“

    - name: Read setting.yml
      run: |
        SETTINGS_FILE="setting.yml"
        if [ -f "$SETTINGS_FILE" ]; then
          enable_specify_images=$(yq e '.["specify-images"].enable' "$SETTINGS_FILE")
          if [ "$enable_specify_images" != "true" ]; then
            echo "specify-imagesæœªå¯ç”¨ï¼Œè·³è¿‡åç»­æ­¥éª¤ã€‚"
            echo "enable_specify_images=false" >> $GITHUB_ENV
          else
            echo "enable_specify_images=true" >> $GITHUB_ENV
            images=$(yq e '.["specify-images"].images | join(",")' "$SETTINGS_FILE")
            echo "images=$images" >> $GITHUB_ENV
          fi
        else
          echo "æœªæ‰¾åˆ° settings.yml æ–‡ä»¶ï¼Œè·³è¿‡åç»­æ­¥éª¤ã€‚"
          echo "enable_specify_images=false" >> $GITHUB_ENV
        fi

    - name: Read Images list, build, and push images to the target registry
      if: env.enable_specify_images == 'true'
      run: |
        docker login -u $MY_REGISTRY_USER -p $MY_REGISTRY_PASSWORD $MY_REGISTRY

        updated_count=0  # åˆå§‹åŒ–æ›´æ–°é•œåƒè®¡æ•°
        skipped_count=0  # åˆå§‹åŒ–è·³è¿‡é•œåƒè®¡æ•°
        failed_count=0   # åˆå§‹åŒ–å¤±è´¥é•œåƒè®¡æ•°
        failed_images=() # å¤±è´¥çš„é•œåƒåˆ—è¡¨
        IFS=',' read -r -a images <<< "$images"  # è¯»å–ç¯å¢ƒå˜é‡ä¸­çš„ä»“åº“æ•°ç»„

        # å®šä¹‰å‡½æ•°ï¼šæ ¼å¼åŒ–è¾“å‡º layers ä¿¡æ¯
        print_layers_info() {
            local layers="$1"
            local label="$2"

            echo "$label"
            if [ ${#layers} -le 100 ]; then
                echo "$layers"
            elif [ ${#layers} -le 200 ]; then
                echo "${layers:0:50}...${layers: -50}"
            else
                echo "${layers:0:50}...${layers:$((${#layers}/2-25)):50}...${layers: -50}"
            fi
        }

        # å¤„ç†é•œåƒæ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªé•œåƒ
        for image in "${images[@]}"; do
            echo "============================================================================="
            echo "å¤„ç†é•œåƒ: $image"

            # è§£æé•œåƒåç§°ï¼ˆä½¿ç”¨æ›´ç®€æ´çš„æ–¹å¼ï¼‰
            if [[ "$image" =~ ^([^/]+)/(.*)$ ]]; then
                registry="${BASH_REMATCH[1]}"
                remainder="${BASH_REMATCH[2]}"

                if [[ "$remainder" =~ ^([^/]+)/(.*)$ ]]; then
                    namespace="${BASH_REMATCH[1]}"
                    repo_and_tag="${BASH_REMATCH[2]}"
                else
                    namespace=""
                    repo_and_tag="$remainder"
                fi

                if [[ "$repo_and_tag" =~ ^([^:]+):?(.*)$ ]]; then
                    repo="${BASH_REMATCH[1]}"
                    tag="${BASH_REMATCH[2]:-latest}"
                else
                    repo="$repo_and_tag"
                    tag="latest"
                fi
            else
                echo "âŒ æ— æ³•è§£æé•œåƒåç§°: $image"
                failed_count=$((failed_count + 1))
                failed_images+=("$image")
                continue
            fi

            echo "è§£æå‡ºçš„æ³¨å†Œè¡¨: $registry"
            echo "è§£æå‡ºçš„å‘½åç©ºé—´: $namespace"
            echo "è§£æå‡ºçš„ä»“åº“: $repo"
            echo "è§£æå‡ºçš„æ ‡ç­¾: $tag"
            echo "----------------------------------------------------"

            target_image="$MY_REGISTRY/${namespace:+$namespace/}$repo:$tag"
            echo "ç›®æ ‡é•œåƒ: $target_image"
            echo "----------------------------------------------------"

            # è·å–æºé•œåƒçš„ manifestï¼ˆåŒ…å«é”™è¯¯å¤„ç†ï¼‰
            if ! source_manifest=$(skopeo inspect docker://$image 2>&1); then
                echo "âŒ æ— æ³•è·å–æºé•œåƒ manifest: $source_manifest"
                failed_count=$((failed_count + 1))
                failed_images+=("$image")
                continue
            fi

            # è·å–é•œåƒå¤§å° - ä» manifest çš„ layers è®¡ç®—
            echo "ğŸ” [DEBUG] å¼€å§‹è®¡ç®—é•œåƒå¤§å°..."

            # æ­¥éª¤1: æ£€æŸ¥ source_manifest çš„ Layers å­—æ®µ
            echo "ğŸ” [DEBUG] æ­¥éª¤1: æ£€æŸ¥ skopeo inspect è¾“å‡ºçš„ Layers å­—æ®µ"
            source_layers_check=$(echo "$source_manifest" | jq -r '.Layers // "null"' 2>/dev/null)
            echo "ğŸ” [DEBUG] source_manifest.Layers = $source_layers_check"

            if [ "$source_layers_check" != "null" ] && [ -n "$source_layers_check" ]; then
                echo "âœ… [DEBUG] Layers å­—æ®µå­˜åœ¨ï¼Œç»§ç»­å¤„ç†"

                # æ­¥éª¤2: è·å– raw manifest
                echo "ğŸ” [DEBUG] æ­¥éª¤2: è·å– raw manifest"
                source_manifest_raw=$(skopeo inspect --raw docker://$image 2>&1)
                echo "ğŸ” [DEBUG] raw manifest é•¿åº¦: ${#source_manifest_raw} å­—ç¬¦"

                # æ­¥éª¤3: æ£€æŸ¥ mediaType
                echo "ğŸ” [DEBUG] æ­¥éª¤3: æ£€æŸ¥ mediaType"
                media_type=$(echo "$source_manifest_raw" | jq -r '.mediaType // "unknown"' 2>/dev/null)
                echo "ğŸ” [DEBUG] mediaType = $media_type"

                # æ­¥éª¤4: æ£€æŸ¥æ˜¯å¦æ˜¯ Manifest List
                echo "ğŸ” [DEBUG] æ­¥éª¤4: åˆ¤æ–­ manifest ç±»å‹"
                if [[ "$media_type" == *"manifest.list"* ]]; then
                    echo "âœ… [DEBUG] è¿™æ˜¯ Manifest List (å¤šæ¶æ„é•œåƒ)"

                    # æ­¥éª¤5: è·å– amd64 digest
                    echo "ğŸ” [DEBUG] æ­¥éª¤5: è·å– amd64/linux çš„ digest"
                    echo "ğŸ” [DEBUG] æŸ¥æ‰¾æ¡ä»¶: architecture=amd64, os=linux"

                    # æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨çš„æ¶æ„
                    echo "ğŸ” [DEBUG] æ‰€æœ‰å¯ç”¨çš„æ¶æ„:"
                    echo "$source_manifest_raw" | jq -r '.manifests[] | "  - \(.platform.os)/\(.platform.architecture): \(.digest)"' 2>/dev/null || echo "  (æ— æ³•è§£æ)"

                    amd64_digest=$(echo "$source_manifest_raw" | jq -r '.manifests[] | select(.platform.architecture == "amd64" and .platform.os == "linux") | .digest' 2>/dev/null | head -1)
                    echo "ğŸ” [DEBUG] amd64_digest = $amd64_digest"

                    if [ -n "$amd64_digest" ] && [ "$amd64_digest" != "null" ]; then
                        # æ­¥éª¤6: æ„é€ å¸¦ digest çš„é•œåƒå¼•ç”¨
                        echo "ğŸ” [DEBUG] æ­¥éª¤6: æ„é€ å¸¦ digest çš„é•œåƒå¼•ç”¨"
                        image_with_digest="${image%%:*}@${amd64_digest}"
                        echo "ğŸ” [DEBUG] image_with_digest = $image_with_digest"

                        # æ­¥éª¤7: è·å– amd64 manifest
                        echo "ğŸ” [DEBUG] æ­¥éª¤7: è·å– amd64 æ¶æ„çš„å…·ä½“ manifest"
                        amd64_manifest=$(skopeo inspect --raw docker://$image_with_digest 2>&1)

                        # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
                        if echo "$amd64_manifest" | grep -q "error"; then
                            echo "âŒ [DEBUG] è·å– amd64 manifest å¤±è´¥:"
                            echo "$amd64_manifest" | head -5
                            source_size=0
                        else
                            echo "âœ… [DEBUG] æˆåŠŸè·å– amd64 manifest"

                            # æ˜¾ç¤º amd64 manifest çš„ mediaType
                            amd64_media_type=$(echo "$amd64_manifest" | jq -r '.mediaType // "unknown"' 2>/dev/null)
                            echo "ğŸ” [DEBUG] amd64 manifest mediaType = $amd64_media_type"

                            # æ£€æŸ¥æ˜¯å¦æœ‰ layers
                            has_layers=$(echo "$amd64_manifest" | jq 'has("layers")' 2>/dev/null)
                            echo "ğŸ” [DEBUG] has(layers) = $has_layers"

                            if [ "$has_layers" = "true" ]; then
                                layers_count=$(echo "$amd64_manifest" | jq '.layers | length' 2>/dev/null)
                                echo "ğŸ” [DEBUG] layers æ•°é‡ = $layers_count"

                                # æ˜¾ç¤ºå‰3ä¸ª layer çš„ä¿¡æ¯
                                echo "ğŸ” [DEBUG] å‰3ä¸ª layers çš„ä¿¡æ¯:"
                                echo "$amd64_manifest" | jq '.layers[0:3] | .[] | "  - size: \(.size), digest: \(.digest[0:30])..."' 2>/dev/null || echo "  (æ— æ³•è§£æ)"

                                # è®¡ç®—æ€»å¤§å°
                                source_size=$(echo "$amd64_manifest" | jq -r '[.layers[].size] | add // 0' 2>/dev/null || echo "0")
                                echo "ğŸ” [DEBUG] è®¡ç®—å¾—åˆ°çš„æ€»å¤§å°: $source_size bytes"
                            else
                                echo "âŒ [DEBUG] amd64 manifest ä¸­æ²¡æœ‰ layers å­—æ®µ"
                                source_size=0
                            fi
                        fi
                    else
                        echo "âŒ [DEBUG] æ— æ³•æ‰¾åˆ° amd64/linux çš„ digest"
                        source_size=0
                    fi
                elif [[ "$media_type" == *"manifest.v2"* ]]; then
                    echo "âœ… [DEBUG] è¿™æ˜¯æ ‡å‡† v2 manifest"

                    # æ£€æŸ¥æ˜¯å¦æœ‰ layers
                    has_layers=$(echo "$source_manifest_raw" | jq 'has("layers")' 2>/dev/null)
                    echo "ğŸ” [DEBUG] has(layers) = $has_layers"

                    if [ "$has_layers" = "true" ]; then
                        layers_count=$(echo "$source_manifest_raw" | jq '.layers | length' 2>/dev/null)
                        echo "ğŸ” [DEBUG] layers æ•°é‡ = $layers_count"

                        # æ˜¾ç¤ºå‰3ä¸ª layer çš„ä¿¡æ¯
                        echo "ğŸ” [DEBUG] å‰3ä¸ª layers çš„ä¿¡æ¯:"
                        echo "$source_manifest_raw" | jq '.layers[0:3] | .[] | "  - size: \(.size), digest: \(.digest[0:30])..."' 2>/dev/null || echo "  (æ— æ³•è§£æ)"

                        # è®¡ç®—æ€»å¤§å°
                        source_size=$(echo "$source_manifest_raw" | jq -r '[.layers[].size] | add // 0' 2>/dev/null || echo "0")
                        echo "ğŸ” [DEBUG] è®¡ç®—å¾—åˆ°çš„æ€»å¤§å°: $source_size bytes"
                    else
                        echo "âŒ [DEBUG] manifest ä¸­æ²¡æœ‰ layers å­—æ®µ"
                        source_size=0
                    fi
                else
                    echo "âŒ [DEBUG] æœªçŸ¥çš„ manifest ç±»å‹: $media_type"
                    # å°è¯•æ˜¾ç¤ºåŸå§‹ JSON çš„å‰å‡ è¡Œ
                    echo "ğŸ” [DEBUG] raw manifest å‰500å­—ç¬¦:"
                    echo "$source_manifest_raw" | head -c 500
                    source_size=0
                fi
            else
                echo "âŒ [DEBUG] source_manifest ä¸­æ²¡æœ‰ Layers å­—æ®µæˆ–ä¸ºç©º"
                echo "ğŸ” [DEBUG] source_manifest å‰500å­—ç¬¦:"
                echo "$source_manifest" | head -c 500
                source_size=0
            fi

            source_size_mb=$(awk "BEGIN {printf \"%.2f\", $source_size / 1024 / 1024}")
            echo "ğŸ” [DEBUG] æœ€ç»ˆç»“æœ: $source_size bytes ($source_size_mb MB)"
            echo "é•œåƒå¤§å°: $source_size bytes (${source_size_mb} MB)"
            echo "----------------------------------------------------"

            source_layers=$(echo "$source_manifest" | jq -r '.Layers[]' | sed -n '2,$p' | tr '\n' ' ')
            print_layers_info "$source_layers" "æºé•œåƒ $image çš„ layersï¼ˆå¿½ç•¥é¦–å±‚åï¼‰:"

            # è·å–ç›®æ ‡é•œåƒçš„ manifest
            target_manifest=$(skopeo inspect --creds $MY_REGISTRY_USER:$MY_REGISTRY_PASSWORD docker://$target_image 2>&1 || echo "")
            if [ -n "$target_manifest" ] && ! echo "$target_manifest" | grep -q "error"; then
                target_layers=$(echo "$target_manifest" | jq -r '.Layers[]' | sed -n '2,$p' | tr '\n' ' ')
                print_layers_info "$target_layers" "ç›®æ ‡é•œåƒ $target_image çš„ layersï¼ˆå¿½ç•¥é¦–å±‚åï¼‰:"
            else
                target_layers=""
            fi
            echo "----------------------------------------------------"

            # æ£€æŸ¥æ˜¯å¦éœ€è¦è·³è¿‡
            if [ -n "$target_layers" ] && [ "$source_layers" == "$target_layers" ]; then
                echo "âœ… é•œåƒ $target_image å·²å­˜åœ¨ä¸”å„å±‚ä¸€è‡´ï¼Œè·³è¿‡ã€‚"
                skipped_count=$((skipped_count + 1))
                continue
            fi

            echo "â¬‡ï¸  å¼€å§‹æ‹‰å–å’Œæ¨é€é•œåƒ..."
            echo "----------------------------------------------------"

            # æ‹‰å–é•œåƒ
            if ! docker pull $image; then
                echo "âŒ Docker æ‹‰å–å¤±è´¥: $image"
                failed_count=$((failed_count + 1))
                failed_images+=("$image")
                continue
            fi

            # æ‰“æ ‡ç­¾
            if ! docker tag $image $target_image; then
                echo "âŒ Docker æ‰“æ ‡ç­¾å¤±è´¥: $image -> $target_image"
                failed_count=$((failed_count + 1))
                failed_images+=("$image")
                continue
            fi

            # æ¨é€é•œåƒ
            if ! docker push $target_image; then
                echo "âŒ Docker æ¨é€å¤±è´¥: $target_image"
                failed_count=$((failed_count + 1))
                failed_images+=("$image")
                continue
            fi

            echo "âœ… é•œåƒæ¨é€æˆåŠŸ: $target_image"
            updated_count=$((updated_count + 1))
        done

        echo "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
        echo "ğŸ“Š å¤„ç†æ±‡æ€»:"
        echo "   æ€»è®¡: ${#images[@]} ä¸ªé•œåƒ"
        echo "   âœ… æ›´æ–°: $updated_count ä¸ª"
        echo "   â­ï¸  è·³è¿‡: $skipped_count ä¸ª"
        echo "   âŒ å¤±è´¥: $failed_count ä¸ª"

        if [ $failed_count -gt 0 ]; then
            echo "   å¤±è´¥çš„é•œåƒ:"
            for img in "${failed_images[@]}"; do
                echo "      - $img"
            done
        fi

        # å°†è½¬å­˜çš„é•œåƒåˆ—è¡¨ä¿å­˜åˆ°ç¯å¢ƒå˜é‡ï¼Œä¾›webhookä½¿ç”¨
        echo "transfer_images=$images" >> $GITHUB_ENV
        echo "transfer_count=$updated_count" >> $GITHUB_ENV
        echo "transfer_skipped=$skipped_count" >> $GITHUB_ENV
        echo "transfer_failed=$failed_count" >> $GITHUB_ENV

    - name: Notify OpenClaw
      if: always()  # æ— è®ºæˆåŠŸæˆ–å¤±è´¥éƒ½å‘é€é€šçŸ¥
      run: |
        echo "=========================================="
        echo "å‘é€ webhook é€šçŸ¥..."
        echo "WEBHOOK_URL: ${{ secrets.OPENCLAW_WEBHOOK_URL }}"
        echo "job.status: ${{ job.status }}"
        echo "github.run_id: ${{ github.run_id }}"
        echo "transfer_images: ${{ env.transfer_images }}"
        echo "transfer_count: ${{ env.transfer_count }}"
        echo "transfer_skipped: ${{ env.transfer_skipped }}"
        echo "transfer_failed: ${{ env.transfer_failed }}"
        echo "=========================================="

        # ç”Ÿæˆ JSON æ•°æ®ï¼ˆå•è¡Œï¼‰- åŒ…å«æ›´è¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯
        WEBHOOK_DATA="{\"event\":\"docker_image_transfer\",\"status\":\"${{ job.status }}\",\"run_id\":\"${{ github.run_id }}\",\"run_number\":\"${{ github.run_number }}\",\"run_url\":\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",\"images\":\"${{ env.transfer_images }}\",\"updated_count\":\"${{ env.transfer_count }}\",\"skipped_count\":\"${{ env.transfer_skipped }}\",\"failed_count\":\"${{ env.transfer_failed }}\",\"actor\":\"${{ github.actor }}\",\"timestamp\":\"$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")\"}"

        echo "å‘é€çš„æ•°æ®: $WEBHOOK_DATA"

        # å‘é€ webhook
        RESPONSE=$(curl -s -w "\n%{http_code}" \
          -X POST "${{ secrets.OPENCLAW_WEBHOOK_URL }}" \
          -H "Authorization: Bearer ${{ secrets.OPENCLAW_HOOK_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d "$WEBHOOK_DATA")

        echo "HTTP çŠ¶æ€ç : $RESPONSE"
        echo "=========================================="